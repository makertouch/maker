<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DXF to PCB Converter</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }
        textarea {
            width: 100%;
            height: 300px;
            margin-top: 20px;
        }
        #convertButton {
            margin-top: 10px;
            padding: 10px;
            background-color: #4CAF50;
            color: white;
            border: none;
            cursor: pointer;
        }
        #convertButton:hover {
            background-color: #45a049;
        }
    </style>
</head>
<body>

    <h1>DXF to PCB Converter</h1>
    <input type="file" id="dxfFileInput" accept=".dxf" />
    <button id="convertButton">Convert to PCB</button>
    <textarea id="gcodeOutput" readonly placeholder="G-code will appear here..."></textarea>

    <script src="https://cdn.jsdelivr.net/npm/dxf-parser/dist/dxf-parser.min.js"></script>
    <script>
        document.getElementById('convertButton').addEventListener('click', function() {
            const fileInput = document.getElementById('dxfFileInput');
            if (fileInput.files.length === 0) {
                alert('Please select a DXF file.');
                return;
            }

            const file = fileInput.files[0];
            const reader = new FileReader();

            reader.onload = function(e) {
                const dxfString = e.target.result;
                const parser = new DxfParser();
                let dxf;
                try {
                    dxf = parser.parseSync(dxfString);
                } catch (err) {
                    alert('Error parsing DXF file: ' + err.message);
                    return;
                }

                const gcode = dxfToGcode(dxf);
                document.getElementById('gcodeOutput').value = gcode.join('\n');
            };

            reader.readAsText(file);
        });

        function dxfToGcode(dxf) {
            const gcode = [];

            gcode.push('Start    0.000,  0.000');

            dxf.entities.forEach(entity => {
                switch (entity.type) {
                    case 'LINE':
                        handleLine(entity, gcode);
                        break;
                    case 'ARC':
                        handleArc(entity, gcode);
                        break;
                    case 'CIRCLE':
                        handleCircle(entity, gcode);
                        break;
                }
            });

            gcode.push('End');
            return gcode;
        }

        function handleLine(entity, gcode) {
            const start = entity.vertices[0];
            const end = entity.vertices[1];
            
            gcode.push(`LineTo ${start.x.toFixed(3)}, ${start.y.toFixed(3)},   0.000, 1,   0.000`); // Move to the starting point
            gcode.push(`LineTo ${end.x.toFixed(3)}, ${end.y.toFixed(3)},   0.000, 1,   0.000`); // Cut to the ending point
        }

        function handleArc(entity, gcode) {
            const startAngle = entity.startAngle;
            const endAngle = entity.endAngle;
            const radius = entity.radius;
            const center = entity.center;

            // Convert angles from degrees to radians
            const startAngleRad = startAngle * Math.PI / 180;
            const endAngleRad = endAngle * Math.PI / 180;

            // Calculate start and end points of the arc
            const startX = (center.x + radius * Math.cos(startAngleRad)).toFixed(3);
            const startY = (center.y + radius * Math.sin(startAngleRad)).toFixed(3);
            const endX = (center.x + radius * Math.cos(endAngleRad)).toFixed(3);
            const endY = (center.y + radius * Math.sin(endAngleRad)).toFixed(3);

            // Add start point to G-code
            gcode.push(`End
Start ${startX}, ${startY}`); // Move to the arc's start point

            // Add arc command to G-code (example format; adjust if necessary for your machine/controller)
            gcode.push(`ArcTo ${endX}, ${endY}, ${center.x.toFixed(3)}, ${center.y.toFixed(3)},   0.000, 1,   0.000`);
        }

        function handleCircle(entity, gcode) {
            const center = entity.center;
            const radius = entity.radius;

            // Calculate the start point on the circumference of the circle
            const startX = (center.x + radius).toFixed(3);
            const startY = center.y.toFixed(3);

            // Calculate the end point as the directly opposite point on the circumference
            const endX = (center.x - radius).toFixed(3);
            const endY = center.y.toFixed(3);

            // Add circle commands to G-code
            gcode.push(`LineTo ${startX}, ${startY},   0.000, 1,   0.000`); // Move to the circle's start point
            gcode.push(`ArcTo ${startX}, ${startY}, ${center.x.toFixed(3)}, ${center.y.toFixed(3)},   0.000, 1,   0.000`); // Draw the circle with center and start point
        }
    </script>

</body>
</html>
